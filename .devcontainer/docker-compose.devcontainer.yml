# Docker Compose additions for the devcontainer.
# This service builds the dev image from the repo Dockerfile and depends
# on the existing `tracker-redis` and `mosquitto` services defined in
# ../docker-compose.yaml.
version: "3.8"

services:
  dev:
    build:
      context: ..
      dockerfile: Dockerfile
    environment:
      IMT_REDIS_ENDPOINT: tracker-redis
      IMT_REDIS_PORT: "6379"
      IMT_REDIS_PASSWORD: mbta
      IMT_PROMETHEUS_ENABLE: "true"
      IMT_PROM_PORT: "8000"
    volumes:
      - ..:/app:cached
      # Persist the venv across container restarts so `uv venv` / `uv sync`
      # doesn't always need to re-create everything.
      - dev_venv:/app/.venv
    working_dir: /app
    tty: true
    stdin_open: true
    # Keep the container alive so you can enter it and run tasks manually
    command: ["tail", "-f", "/dev/null"]
    depends_on:
      - tracker-redis
      - mosquitto
    ports:
      - "8000:8000"
      - "8080:8080"

volumes:
  dev_venv:
    driver: local